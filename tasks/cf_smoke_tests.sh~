jobs:
- name: cf_smoke_tests
  serial: true
  plan:
  - aggregate:
    - get: timer
      trigger: true
    - get: cf-smoke-tests
      trigger: false
    - get: mpcf-harley-davidson-git
      trigger: false
  - task: test
    file:  mpcf-harley-davidson-git/concourse/tasks/cf_smoke_tests.yml
    timeout: 20m
    params:
      cf_api: ((cf_api))
      cf_user: ((cf_user))
      cf_password: ((cf_password))
      cf_org: ((cf_org))
      cf_space: ((cf_space))
      cf_apps_domain: ((cf_apps_domain))
      cf_deployment: ((cf_deployment))
    on_failure:
      task: trigger
      file: mpcf-harley-davidson-git/concourse/tasks/cf_smoke_tests_trigger.yml
      params:
        service_key: ((cf_smoke_tests.pd_service_key))
        CONCOURSE_USERNAME: ((concourse_username))
        CONCOURSE_PASSWORD: ((concourse_password))
    on_success:
      task: resolve
      file: mpcf-harley-davidson-git/concourse/tasks/cf_smoke_tests_resolve.yml
      params:
        service_key: ((cf_smoke_tests.pd_service_key))

resources:
- name: cf-smoke-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-smoke-tests
    branch: master

- name: timer
  type: time
  source:
    interval: 6m

- name: mpcf-harley-davidson-git
  type: git
  source:
    uri: git@github.com:rackerlabs/mpcf-harley-davidson-cfprod-aws.git
    branch: master
    private_key: ((hd_concourse_github_key.private_key))
